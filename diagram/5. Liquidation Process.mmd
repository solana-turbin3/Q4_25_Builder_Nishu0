flowchart TB
    Start([ğŸ” Liquidation Bot<br/>Scans Positions])
    
    FetchPos[ğŸ“‹ Fetch All Short Positions<br/>via getProgramAccounts]
    
    Loop{For Each<br/>Position}
    
    GetCollat[ğŸ’° Get Collateral Value<br/>from Vault + Oracle]
    
    GetDebt[ğŸ“Š Get Debt Value<br/>quantity Ã— indexÂ²]
    
    CalcHealth[ğŸ©º Calculate Health Score<br/>collateral / debt]
    
    CheckHealth{Health < 1.0?<br/>Below 150% ratio}
    
    AddQueue[â• Add to<br/>Liquidation Queue]
    
    NextPos[â¡ï¸ Next Position]
    
    SortQueue[ğŸ“Š Sort Queue by<br/>Lowest Health First]
    
    LiqLoop{For Each<br/>Liquidatable}
    
    CalcLiqAmount[ğŸ’µ Calculate Liquidation<br/>debt Ã— 1.05 = bonus]
    
    BuyTokens[ğŸ›’ Liquidator Buys<br/>Power Perp Tokens]
    
    CallLiq[ğŸ“ Call liquidate_position<br/>Submit Tokens]
    
    VerifyHealth[âœ… Verify Still<br/>Underwater]
    
    BurnTokens[ğŸ”¥ Burn Submitted<br/>Power Perp Tokens]
    
    CalcCollat{Collateral<br/>Sufficient?}
    
    PayLiquidator[ğŸ’¸ Pay Liquidator<br/>Collateral + 5% Bonus]
    
    PayPartial[âš ï¸ Pay All Available<br/>Mark Loss for Insurance]
    
    ClosePos[âŒ Close Position<br/>Account]
    
    EmitEvent[ğŸ“¢ Emit PositionLiquidated<br/>Event]
    
    NextLiq[â¡ï¸ Next Liquidation]
    
    End([âœ… Scan Complete])
    
    Start --> FetchPos
    FetchPos --> Loop
    
    Loop -->|Yes| GetCollat
    Loop -->|No| SortQueue
    
    GetCollat --> GetDebt
    GetDebt --> CalcHealth
    CalcHealth --> CheckHealth
    
    CheckHealth -->|Yes| AddQueue
    CheckHealth -->|No| NextPos
    
    AddQueue --> NextPos
    NextPos --> Loop
    
    SortQueue --> LiqLoop
    
    LiqLoop -->|Yes| CalcLiqAmount
    LiqLoop -->|No| End
    
    CalcLiqAmount --> BuyTokens
    BuyTokens --> CallLiq
    CallLiq --> VerifyHealth
    VerifyHealth --> BurnTokens
    BurnTokens --> CalcCollat
    
    CalcCollat -->|Yes| PayLiquidator
    CalcCollat -->|No| PayPartial
    
    PayLiquidator --> ClosePos
    PayPartial --> ClosePos
    
    ClosePos --> EmitEvent
    EmitEvent --> NextLiq
    NextLiq --> LiqLoop
    
    style Start fill:#e1ffe1
    style CheckHealth fill:#ffe1e1
    style AddQueue fill:#fff4e1
    style CalcCollat fill:#ffe1e1
    style PayPartial fill:#ffcccc
    style End fill:#e1ffe1