flowchart TD
    Start([â° 8 Hours Elapsed])
    
    Crank[ğŸ¤– Funding Crank Bot<br/>Calls apply_funding]
    
    FetchMark[ğŸ“Š Fetch Mark Price<br/>from Pool/Oracle]
    FetchIndex[ğŸ”® Fetch Index Price<br/>from Pyth: SOLÂ²]
    
    CalcRate{Calculate Rate<br/>mark - index / index}
    
    CheckCap{Rate > Â±10%?}
    
    ApplyCap[ğŸ“Œ Cap at Â±10%]
    UseRate[âœ… Use Calculated Rate]
    
    IteratePos[ğŸ”„ Iterate All Long Positions]
    
    CalcPayment[ğŸ’µ Calculate Payment<br/>quantity Ã— index Ã— rate Ã— time]
    
    DeductCollat[â¬‡ï¸ Deduct from<br/>User's Collateral]
    
    CheckSufficient{Collateral<br/>Sufficient?}
    
    CreditLP[â¬†ï¸ Credit to<br/>LP Vault]
    
    FlagLiq[âš ï¸ Flag for<br/>Liquidation]
    
    UpdateTS[ğŸ• Update<br/>last_funding_timestamp]
    
    EmitEvent[ğŸ“¢ Emit FundingApplied<br/>Event]
    
    End([âœ… Funding Complete])
    
    Start --> Crank
    Crank --> FetchMark
    Crank --> FetchIndex
    FetchMark --> CalcRate
    FetchIndex --> CalcRate
    
    CalcRate --> CheckCap
    CheckCap -->|Yes| ApplyCap
    CheckCap -->|No| UseRate
    
    ApplyCap --> IteratePos
    UseRate --> IteratePos
    
    IteratePos --> CalcPayment
    CalcPayment --> DeductCollat
    DeductCollat --> CheckSufficient
    
    CheckSufficient -->|Yes| CreditLP
    CheckSufficient -->|No| FlagLiq
    
    CreditLP --> UpdateTS
    FlagLiq --> UpdateTS
    
    UpdateTS --> EmitEvent
    EmitEvent --> End
    
    style Start fill:#e1ffe1
    style Crank fill:#fff4e1
    style CheckCap fill:#ffe1e1
    style CheckSufficient fill:#ffe1e1
    style End fill:#e1ffe1