sequenceDiagram
    participant User
    participant Frontend
    participant Position Program
    participant Token Program
    participant Vault Program
    participant Oracle
    
    User->>Frontend: Click "Close Position"
    Frontend->>Position Program: Get Position Details
    Position Program-->>Frontend: 2 SOL², Entry $10k, Collateral 10 SOL
    
    Frontend->>Oracle: Get Current SOL Price
    Oracle-->>Frontend: $120
    
    Frontend->>Frontend: Calculate PNL
    Note over Frontend: Current: 2 × $14,400 = $28,800<br/>Entry: 2 × $10,000 = $20,000<br/>PNL: +$8,800
    
    Frontend->>User: Show PNL: +$8,800<br/>Confirm Close?
    User->>Frontend: Confirm
    
    Frontend->>Position Program: close_long_position()
    
    Position Program->>Position Program: Verify User Owns Position
    
    Position Program->>Token Program: Check User Has 2 SOL²
    Token Program-->>Position Program: ✅ Balance: 2 SOL²
    
    Position Program->>Position Program: Calculate Final Funding Owed
    Note over Position Program: Outstanding: -$25
    
    Position Program->>Token Program: Burn 2 SOL² from User
    Token Program->>Token Program: Destroy Tokens
    
    Position Program->>Vault Program: Unlock Collateral
    Vault Program->>Vault Program: Calculate Return Amount
    Note over Vault Program: 10 SOL - $25 funding = 9.975 SOL
    
    Vault Program->>User: Transfer 9.975 SOL
    
    Position Program->>Position Program: Close Position Account<br/>Reclaim Rent
    
    Position Program->>Frontend: ✅ Position Closed
    Frontend->>User: Success! Profit realized<br/>through SOL appreciation